<div>Teachable Machine Image Model</div>
<button type="button" onclick="init()">Start</button>
<div id="webcam-container"></div>
<div id="label-container"></div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
<script type="text/javascript">
    const URL = "https://teachablemachine.withgoogle.com/models/oN-RCT-YD/";
    let model, webcam, labelContainer, maxPredictions;
    let lastUpdateTime = 0; // to control ThingSpeak rate limit (15s)

    async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        const flip = true;
        webcam = new tmImage.Webcam(200, 200, flip);
        await webcam.setup();
        await webcam.play();
        window.requestAnimationFrame(loop);

        document.getElementById("webcam-container").appendChild(webcam.canvas);
        labelContainer = document.getElementById("label-container");
        for (let i = 0; i < maxPredictions; i++) {
            labelContainer.appendChild(document.createElement("div"));
        }
    }

    async function loop() {
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);

        for (let i = 0; i < maxPredictions; i++) {
            const classPrediction =
                prediction[i].className + ": " + prediction[i].probability.toFixed(2);
            labelContainer.childNodes[i].innerHTML = classPrediction;
        }

        // Check conditions for Class 1 or Class 2
        if (prediction[0].probability >= 0.8) {
            sendToThingSpeak(1, 0);  // Class1 → Field1=1, Field2=0
        } else if (prediction[1].probability >= 0.8) {
            sendToThingSpeak(0, 1);  // Class2 → Field1=0, Field2=1
        }
    }

    // Function to send data to ThingSpeak (with 15s delay)
    function sendToThingSpeak(field1Value, field2Value) {
        const now = Date.now();
        if (now - lastUpdateTime < 15000) {
            return; // avoid sending too often
        }
        lastUpdateTime = now;

        const apiKey = "RVM93PYQL3CHL23X";  // Your ThingSpeak Write API Key
        const url = `https://api.thingspeak.com/update?api_key=${apiKey}&field1=${field1Value}&field2=${field2Value}`;
        
        fetch(url)
            .then(response => console.log("Data sent to ThingSpeak:", response))
            .catch(error => console.error("Error:", error));
    }
</script>
